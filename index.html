<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Cloud</title>
<style>
:root{
  --bg:#0b0f19;
  --panel:#020617;
  --border:#1e293b;
  --hover:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text)
}
.app{display:flex;height:100vh}
.sidebar{
  width:320px;
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:6px;
  overflow:auto
}
.main{flex:1;padding:10px}
.toolbar{display:flex;gap:8px;margin-bottom:8px}
input,button{
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 12px;
  border-radius:8px
}
button:hover{background:var(--hover)}
.path{font-size:13px;color:var(--muted);margin-bottom:6px}

.row{
  display:flex;
  align-items:center;
  gap:6px;
  padding:3px 6px;
  border-radius:6px;
  cursor:pointer
}
.row:hover{background:var(--hover)}
.arrow{width:14px;color:var(--muted)}
.dir{color:var(--accent);font-weight:600}
.file{color:var(--text)}
.del{
  margin-left:auto;
  color:var(--danger);
  cursor:pointer
}
.hidden{display:none}
</style>
</head>
<body>

<div class="app">
  <div class="sidebar" id="tree"></div>
  <div class="main">
    <div class="path" id="cwd">/</div>

    <div class="toolbar">
      <button onclick="pickFiles()">Upload Files</button>
      <button onclick="pickFolder()">Upload Folder</button>
      <button onclick="goRoot()">Root</button>
    </div>

    <input id="filePicker" class="hidden" type="file" multiple accept="*/*">
    <input id="folderPicker" class="hidden" type="file" webkitdirectory>
  </div>
</div>

<script>
const BACKEND = "https://created-pierce-eventually-src.trycloudflare.com"

const tree = document.getElementById("tree")
const cwdEl = document.getElementById("cwd")
const filePicker = document.getElementById("filePicker")
const folderPicker = document.getElementById("folderPicker")

let cwd=""
const openDirs=new Set()

const CHUNK_SIZE = 10 * 1024 * 1024

function goRoot(){
  cwd=""
  load()
  updatePath()
}

function updatePath(){
  cwdEl.textContent="/"+(cwd||"")
}


function pickFiles(){
  filePicker.value=""
  filePicker.click()
}

function pickFolder(){
  folderPicker.value=""
  folderPicker.click()
}

filePicker.onchange = () => uploadFiles(filePicker.files, false)
folderPicker.onchange = () => uploadFiles(folderPicker.files, true)


async function uploadFiles(files, isFolder){
  if(!files.length) return

  for(const file of files){
    const rel = isFolder && file.webkitRelativePath
      ? file.webkitRelativePath.split("/").slice(1).join("/")
      : file.name

    const base = cwd
    const total = Math.ceil(file.size / CHUNK_SIZE)

    for(let i=0;i<total;i++){
      const chunk = file.slice(
        i * CHUNK_SIZE,
        Math.min((i + 1) * CHUNK_SIZE, file.size)
      )

      await fetch(
        `${BACKEND}/upload-chunk` +
        `?name=${encodeURIComponent(file.name)}` +
        `&chunkIndex=${i}` +
        `&totalChunks=${total}` +
        `&path=${encodeURIComponent(base)}`,
        { method:"POST", body:chunk }
      )
    }
  }

  load()
}


function render(nodes,el,depth=0){
  nodes.forEach(n=>{
    const row=document.createElement("div")
    row.className="row"
    row.style.marginLeft=(depth*14)+"px"

    if(n.type==="dir"){
      const open=openDirs.has(n.path)
      row.innerHTML=`<div class="arrow">${open?"▼":"▶"}</div><div class="dir">${n.name}</div>`
      const del=document.createElement("div")
      del.className="del"
      del.textContent="×"
      del.onclick=e=>{e.stopPropagation();remove(n.path)}
      row.appendChild(del)

      row.onclick=()=>{
        open?openDirs.delete(n.path):openDirs.add(n.path)
        load()
      }
      el.appendChild(row)
      if(open) render(n.children,el,depth+1)
    }else{
      row.innerHTML=`<div class="arrow"></div><div class="file">${n.name}</div>`
      const del=document.createElement("div")
      del.className="del"
      del.textContent="×"
      del.onclick=e=>{e.stopPropagation();remove(n.path)}
      row.appendChild(del)
      row.onclick=()=>download(n.path,n.name)
      el.appendChild(row)
    }
  })
}

function load(){
  fetch(BACKEND+"/files")
    .then(r=>r.json())
    .then(d=>{
      tree.innerHTML=""
      render(d,tree)
    })
}


function download(p,n){
  fetch(BACKEND+"/download?path="+encodeURIComponent(p))
    .then(r=>r.blob())
    .then(b=>{
      const u=URL.createObjectURL(b)
      const a=document.createElement("a")
      a.href=u;a.download=n;a.click()
      URL.revokeObjectURL(u)
    })
}

function remove(p){
  if(!confirm("Delete "+p+" ?")) return
  fetch(BACKEND+"/delete",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ path:p })
  }).then(()=>load())
}

load()
updatePath()
</script>

</body>
</html>
