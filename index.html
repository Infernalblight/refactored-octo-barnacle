<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Cloud</title>
<style>
:root{
  --bg:#0b0f19;
  --panel:#020617;
  --border:#1e293b;
  --hover:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.app{display:flex;height:100vh}
.sidebar{width:320px;background:var(--panel);border-right:1px solid var(--border);padding:6px;overflow:auto}
.main{flex:1;padding:10px}
.toolbar{display:flex;gap:8px;margin-bottom:8px}
button,input{
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer
}
button:hover{background:var(--hover)}
.path{font-size:13px;color:var(--muted);margin-bottom:6px}

.row{display:flex;align-items:center;gap:6px;padding:3px 6px;border-radius:6px;cursor:pointer}
.row:hover{background:var(--hover)}
.arrow{width:14px;color:var(--muted)}
.dir{color:var(--accent);font-weight:600}
.del{margin-left:auto;color:var(--danger)}
.hidden{display:none}
</style>
</head>
<body>

<div class="app">
  <div class="sidebar" id="tree"></div>
  <div class="main">
    <div class="path" id="cwd">/</div>
    <div class="toolbar">
      <button onclick="pickFolder()">Upload Folder</button>
      <button onclick="goRoot()">Root</button>
    </div>
    <input id="folderPicker" class="hidden" type="file" webkitdirectory>
  </div>
</div>

<script>
const BACKEND = "https://generates-amp-lyrics-branches.trycloudflare.com"

const tree = document.getElementById("tree")
const cwdEl = document.getElementById("cwd")
const folderPicker = document.getElementById("folderPicker")

let cwd=""
const openDirs=new Set()
const CHUNK=10*1024*1024

function goRoot(){cwd="";load();updatePath()}
function updatePath(){cwdEl.textContent="/"+(cwd||"")}

function pickFolder(){
  folderPicker.value=""
  folderPicker.click()
}

folderPicker.onchange=()=>uploadFolder(folderPicker.files)

async function uploadFolder(files){
  if(!files.length) return
  const top = files[0].webkitRelativePath.split("/")[0]

  for(const f of files){
    const rel = f.webkitRelativePath.split("/").slice(1).join("/")
    const total = Math.ceil(f.size / CHUNK)

    for(let i=0;i<total;i++){
      const chunk = f.slice(i*CHUNK, Math.min((i+1)*CHUNK, f.size))
      await fetch(
        `${BACKEND}/upload-chunk?folder=${encodeURIComponent(top)}&file=${encodeURIComponent(rel)}&chunkIndex=${i}&totalChunks=${total}`,
        { method:"POST", body:chunk }
      )
    }
  }
  load()
}

function render(nodes,el,depth=0){
  nodes.forEach(n=>{
    const row=document.createElement("div")
    row.className="row"
    row.style.marginLeft=(depth*14)+"px"

    if(n.type==="dir"){
      const open=openDirs.has(n.path)
      row.innerHTML=`<div class="arrow">${open?"▼":"▶"}</div><div class="dir">${n.name}</div>`
      const del=document.createElement("div")
      del.className="del"
      del.textContent="×"
      del.onclick=e=>{e.stopPropagation();remove(n.path)}
      row.appendChild(del)

      row.ondblclick=()=>window.open(`${BACKEND}/download-folder?path=${encodeURIComponent(n.path)}`)
      row.onclick=()=>{open?openDirs.delete(n.path):openDirs.add(n.path);load()}

      el.appendChild(row)
      if(open) render(n.children,el,depth+1)
    }
  })
}

function load(){
  fetch(BACKEND+"/files")
    .then(r=>r.json())
    .then(d=>{tree.innerHTML="";render(d,tree)})
}

function remove(p){
  if(!confirm("Delete folder "+p+" ?")) return
  fetch(BACKEND+"/delete",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ path:p })
  }).then(()=>load())
}

load()
updatePath()
</script>

</body>
</html>
