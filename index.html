<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Cloud</title>
<style>
body{margin:0;font-family:system-ui;background:#0b0f19;color:#e5e7eb}
.app{display:flex;height:100vh}
.sidebar{width:260px;background:#020617;padding:8px;overflow:auto}
.main{flex:1;padding:8px}
.item{padding:4px 8px;border-radius:6px;cursor:pointer}
.item:hover{background:#1e293b}
.dir{color:#38bdf8;font-weight:600}
.file{color:#e5e7eb}
.toolbar{display:flex;gap:8px;margin-bottom:8px}
input,button{background:#020617;border:1px solid #1e293b;color:#e5e7eb;padding:6px 10px;border-radius:8px}
</style>
</head>
<body>

<div class="app">
  <div class="sidebar" id="tree"></div>

  <div class="main">
    <div class="toolbar">
      <input type="password" id="pw" placeholder="Password">
      <input type="file" id="picker" multiple webkitdirectory>
      <button onclick="upload()">Upload</button>
    </div>
  </div>
</div>

<script>
const BACKEND = "https://breaks-buck-ham-yea.trycloudflare.com"
let cwd = ""

function headers(extra = {}) {
  return {
    "x-password": pw.value,
    ...extra
  }
}

function render(nodes, el) {
  nodes.forEach(n => {
    const d = document.createElement("div")
    d.className = "item " + n.type
    d.textContent = n.name

    if (n.type === "dir") {
      d.onclick = () => { cwd = n.path; load() }
      el.appendChild(d)

      const sub = document.createElement("div")
      sub.style.paddingLeft = "12px"
      el.appendChild(sub)
      render(n.children, sub)
    } else {
      d.onclick = () => download(n.path, n.name)
      el.appendChild(d)
    }
  })
}

function load() {
  fetch(BACKEND + "/files", { headers: headers() })
    .then(r => r.json())
    .then(d => {
      tree.innerHTML = ""
      render(d, tree)
    })
}

function download(path, name) {
  fetch(BACKEND + "/download?path=" + encodeURIComponent(path), {
    headers: headers()
  })
  .then(r => r.blob())
  .then(b => {
    const u = URL.createObjectURL(b)
    const a = document.createElement("a")
    a.href = u
    a.download = name
    a.click()
    URL.revokeObjectURL(u)
  })
}

function upload() {
  const files = picker.files
  if (!files.length) return

  const fd = new FormData()

  let basePath = cwd

  if (files[0].webkitRelativePath) {
    const topFolder = files[0].webkitRelativePath.split("/")[0]
    basePath = cwd ? cwd + "/" + topFolder : topFolder
  }

  for (const f of files) {
    const relative = f.webkitRelativePath
      ? f.webkitRelativePath.split("/").slice(1).join("/")
      : f.name

    fd.append("files", f, relative)
  }

  fetch(BACKEND + "/upload", {
    method: "POST",
    headers: headers({ "x-path": basePath }),
    body: fd
  }).then(() => load())
}

load()
</script>
</body>
</html>
